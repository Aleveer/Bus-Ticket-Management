<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
  <title>Dashboard</title>
  <div th:insert="~{dashboard-header.html}"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
  <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
</head>

<body class="vertical-layout vertical-menu 2-columns menu-expanded fixed-navbar" data-open="click"
  data-menu="vertical-menu" data-color="bg-chartbg" data-col="2-columns">

  <!-- Include Navigation Bar -->
  <nav th:insert="~{navigation-bar.html}"></nav>

  <!-- Include Main Menu -->
  <div th:insert="~{main-menu.html}"></div>

  <!-- Main Content -->
  <div class="app-content content">
    <div class="content-wrapper">
      <!-- Background Layer -->
      <div class="content-wrapper-before"></div>

      <!-- Header Section -->
      <div class="content-header row"></div>

      <!-- Content Body -->
      <div class="content-body">

        <!-- Gradient Line Chart Section -->
        <section class="chart-section row match-height mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div id="gradient-line-chart1" class="height-250 GradientlineShadow1"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Statistics Section -->
        <section class="statistics-section row">
          <!-- Top Customer by Bookings -->
          <div class="col-xl-4 col-lg-12 mb-4">
            <div class="card">
              <div class="card-header">
                <h4 class="card-title">Top Customer by Bookings</h4>
              </div>
              <div class="card-content">
                <div class="card-body">
                  <div class="date-filter mb-3">
                    <label for="startDate">Start Date:</label>
                    <input type="datetime-local" id="startDate" class="form-control">
                    <label for="endDate" class="mt-2">End Date:</label>
                    <input type="datetime-local" id="endDate" class="form-control">
                    <button id="fetchData" class="btn btn-primary mt-3">Fetch Data</button>
                  </div>
                  <!-- Chart -->
                  <div id="topCustomerChart" style="height: 370px; width: 100%;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Progress Stats -->
          <div class="col-xl-4 col-lg-6 col-md-12 mb-4">
            <div class="card pull-up ecom-card-1 bg-white">
              <div class="card-content ecom-card2 height-180">
                <h5 class="text-muted danger position-absolute p-1">Top trips executed by Route</h5>
                <div>
                  <i class="ft-pie-chart danger font-large-1 float-right p-1"></i>
                </div>
                <div class="progress-stats-container ct-golden-section height-75 position-relative pt-3">
                  <canvas id="progressStatsChart" width="400" height="200"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Activity Stats -->
          <div class="col-xl-4 col-lg-6 col-md-12 mb-4">
            <div class="card pull-up ecom-card-1 bg-white">
              <div class="card-content ecom-card2 height-180">
                <h5 class="text-muted info position-absolute p-1">Activity Stats</h5>
                <div>
                  <i class="ft-activity info font-large-1 float-right p-1"></i>
                </div>
                <div class="progress-stats-container ct-golden-section height-75 position-relative pt-3">
                  <div id="progress-stats-bar-chart1"></div>
                  <div id="progress-stats-line-chart1" class="progress-stats-shadow"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div> <!-- End Content Body -->
    </div> <!-- End Content Wrapper -->
  </div> <!-- End App Content -->

  <!-- JavaScript Section -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Set default date range
      const now = new Date();
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(now.getDate() - 7);

      document.getElementById('startDate').value = oneWeekAgo.toISOString().slice(0, 16);
      document.getElementById('endDate').value = now.toISOString().slice(0, 16);

      document.getElementById('fetchData').addEventListener('click', function () {
        const startDate = new Date(document.getElementById('startDate').value).toISOString();
        const endDate = new Date(document.getElementById('endDate').value).toISOString();

        fetch(`/api/statistics/top-customer?startDate=${startDate}&endDate=${endDate}`)
          .then(response => response.json())
          .then(data => {
            console.log('Top Customer Data:', data);
            const dataPoints = data.map(item => ({ label: item.email, y: item.numberOfBookings }));

            const chart = new CanvasJS.Chart("topCustomerChart", {
              theme: "light2",
              animationEnabled: true,
              title: {
                text: "Top Customer by Bookings"
              },
              axisY: {
                title: "Number of Bookings"
              },
              data: [{
                type: "column",
                dataPoints: dataPoints
              }]
            });
            chart.render();
          });
      });

      // Fetch trip count by route
      fetch('/api/statistics/trip-count-by-route')
        .then(response => response.json())
        .then(data => {
          console.log('Trip Count by Route Data:', data);
          const labels = data.slice(0, 5).map(item => item[0]);
          const values = data.slice(0, 5).map(item => item[1]);

          const ctxProgress = document.getElementById('progressStatsChart').getContext('2d');
          new Chart(ctxProgress, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Number of Trips',
                data: values,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        });
    });
  </script>
</body>

</html>