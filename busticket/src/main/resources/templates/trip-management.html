<!DOCTYPE html>
<html class="loading" lang="en" data-text-direction="ltr">

<head>
  <title>Trip Management</title>
  <div th:insert="~{dashboard-header.html}"></div>
  <link rel="stylesheet" th:href="@{/theme-assets/css/pagination.css}">
  <style>
    .btn-darker-red {
      background-color: #8B0000;
      /* Darker red color */
      border-color: #8B0000;
      color: white;
    }
  </style>
</head>

<body class="vertical-layout vertical-menu 2-columns menu-expanded fixed-navbar" data-open="click"
  data-menu="vertical-menu" data-color="bg-gradient-x-purple-blue" data-col="2-columns">
  <!--navigation bar-->
  <nav th:insert="~{navigation-bar.html}"></nav>
  <!-- main menu-->
  <div th:insert="~{main-menu.html}"></div>

  <div class="app-content content">
    <div class="content-wrapper">
      <div class="content-wrapper-before"></div>
      <div class="content-header row">
        <div class="content-header-left col-md-4 col-12 mb-2">
          <h3 class="content-header-title">Tables</h3>
        </div>
        <div class="content-header-right col-md-8 col-12">
          <div class="breadcrumbs-top float-md-right">
            <div class="breadcrumb-wrapper mr-1">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a>
                </li>
                <li class="breadcrumb-item active">Tables
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <div class="content-body"><!-- Basic Tables start -->
        <!-- Basic Tables end -->
        <!-- Striped rows start -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h4 class="card-title">Trip</h4>
                <a class="heading-elements-toggle"><i class="la la-ellipsis-v font-medium-3"></i></a>
                <div class="heading-elements">
                  <ul class="list-inline mb-0">
                    <li><a data-action="search" title="Search"><i class="ft-search"></i></a></li>
                    <a th:href="@{/admin/new-trip}" data-action="add-trip" title="Add Trip">
                      <i class="ft-plus"></i>
                    </a>
                  </ul>
                </div>
                <div class="search-box" id="searchBox" style="display: none;">
                  <input type="text" class="input-search" placeholder="Search trip...">
                  <button class="btn-search" id="searchButton">
                    <i class="ft-search"></i>
                  </button>
                </div>
              </div>
              <div class="card-content collapse show">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th scope="col">Id</th>
                        <th scope="col">Departure</th>
                        <th scope="col">Arrival </th>
                        <th scope="col">Price</th>
                        <th scope="col">Status</th>
                        <th scope="col">Action</th>
                        <!-- <th scope="col">Bus</th>
                        <th scope="col">Driver</th>
                        <th scope="col">Controller</th>
                        <th scope="col">Staff</th>
                        <th scope="col">Route</th>
                        <th scope="col">Seat</th> -->
                      </tr>
                    </thead>
                    <tbody id="tripTableBody">
                      <tr th:each="trip : ${trips}">
                        <td th:text="${trip.tripId}"></td>
                        <td th:text="${trip.departureTime}"></td>
                        <td th:text="${trip.arrivalTime}"></td>
                        <td th:text="${trip.price}"></td>
                        <td th:text="${trip.status}"></td>
                        <td>
                          <button class="btn btn-primary btn-sm" title="View Details"
                            onclick="viewTripDetails('${trip.tripId}')">
                            <i class="ft-eye"></i>
                          </button>
                          <button class="btn btn-warning btn-sm" title="Update Trip"
                            onclick="updateTrip('${trip.tripId}')">
                            <i class="ft-settings"></i>
                          </button>
                          <button class="btn btn-danger btn-sm" title="Delete Trip"
                            onclick="deleteTrip('${trip.tripId}')">
                            <i class="ft-trash"></i>
                          </button>
                          <!--Force delete button-->
                          <button class="btn btn-darker-red btn-sm" title="Force Delete Trip"
                            onclick="deleteTrip('${trip.tripId}', true)">
                            <i class="ft-trash"></i>
                          </button>
                        </td>
                        <!-- <td th:text="${trip.bus.plate}"></td>
                        <td th:text="${trip.driver.driverId}"></td>
                        <td th:text="${trip.controller.id}"></td>
                        <td th:text="${trip.staff.staffId}"></td>
                        <td th:text="${trip.route.routeId}"></td>
                        <td th:text="${trip.numberOfSeatAvailable}"></td> -->
                      </tr>
                    </tbody>
                  </table>
                  <div class="pagination">
                    <ul class="pagination-list" id="paginationControls">
                      <li th:if="${currentPage > 0}">
                        <a onclick="loadTrips('${currentPage - 1}')" aria-label="Previous">&laquo;</a>
                      </li>
                      <li th:each="pageNum : ${pageNumbers}" th:class-append="${pageNum == currentPage} ? 'active'">
                        <a onclick="loadTrips('${pageNum}')" th:text="${pageNum}"></a>
                      </li>
                      <li th:if="${currentPage < totalPages - 1}">
                        <a onclick="loadTrips('${currentPage + 1}')" aria-label="Next">&raquo;</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Striped rows end -->

        <!-- Table head options start -->
        <!-- Table head options end -->

        <!-- Bordered table start -->
        <!-- Bordered table end -->
      </div>
    </div>
  </div>

  <footer>
    <div th:insert="~{dashboard-footer.html}"></div>
  </footer>

  <!-- BEGIN VENDOR JS-->
  <script th:src="@{/theme-assets/vendors/js/vendors.min.js}" type="text/javascript"></script>
  <!-- BEGIN VENDOR JS-->
  <!-- BEGIN PAGE VENDOR JS-->
  <!-- END PAGE VENDOR JS-->
  <!-- BEGIN CHAMELEON  JS-->
  <script th:src="@{/theme-assets/js/core/app-menu-lite.js}" type="text/javascript"></script>
  <script th:src="@{/theme-assets/js/core/app-lite.js}" type="text/javascript"></script>
  <!-- END CHAMELEON  JS-->
  <!-- BEGIN PAGE LEVEL JS-->
  <!-- END PAGE LEVEL JS-->
  <script>
    function loadTrips(page) {
      $.ajax({
        url: '/admin/api/trips',
        data: { page: page, size: 15 },
        success: function (data) {
          var trips = data.trips;
          var totalPages = data.totalPages;
          var currentPage = data.currentPage;

          // Clear the table body
          $('#tripTableBody').empty();

          // Populate the table with trips
          trips.forEach(function (trip) {
            $('#tripTableBody').append(
              '<tr>' +
              '<td>' + trip.tripId + '</td>' +
              '<td>' + trip.departureTime + '</td>' +
              '<td>' + trip.arrivalTime + '</td>' +
              '<td>' + trip.price + '</td>' +
              '<td>' + trip.status + '</td>' +
              "<td>" +
              '<button class="btn btn-primary btn-sm" title="View Details" onclick="viewTripDetails(\'' +
              trip.tripId +
              "')\">" +
              '<i class="ft-eye"></i>' +
              "</button>" +
              '<button class="btn btn-warning btn-sm" title="Update Trip" onclick="updateTrip(\'' +
              trip.tripId +
              "')\">" +
              '<i class="ft-settings"></i>' +
              "</button>" +
              '<button class="btn btn-danger btn-sm" title="Delete Trip" onclick="deleteTrip(\'' +
              trip.tripId +
              "')\">" +
              '<i class="ft-trash"></i>' +
              "</button>" +
              '<button class="btn btn-danger btn-sm" title="Force Delete Trip" onclick="deleteTrip(\'' +
              trip.tripId +
              "', true)\">" +
              '<i class="ft-trash"></i>' +
              "</button>" +
              "</td>" +
              '</tr>'
            );
          });

          // Clear the pagination controls
          $('#paginationControls').empty();

          // Add Previous button
          if (currentPage > 0) {
            $('#paginationControls').append(
              '<li><a onclick="loadTrips(' + (currentPage - 1) + ')">&laquo;</a></li>'
            );
          }

          // Add page numbers with ellipsis
          var startPage = Math.max(0, currentPage - 2);
          var endPage = Math.min(totalPages - 1, currentPage + 2);

          if (startPage > 0) {
            $('#paginationControls').append(
              '<li><a onclick="loadTrips(0)">1</a></li>'
            );
            if (startPage > 1) {
              $('#paginationControls').append(
                '<li><span>...</span></li>'
              );
            }
          }

          for (var i = startPage; i <= endPage; i++) {
            $('#paginationControls').append(
              '<li class="' + (i === currentPage ? 'active' : '') + '"><a onclick="loadTrips(' + i + ')">' + (i + 1) + '</a></li>'
            );
          }

          if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) {
              $('#paginationControls').append(
                '<li><span>...</span></li>'
              );
            }
            $('#paginationControls').append(
              '<li><a onclick="loadTrips(' + (totalPages - 1) + ')">' + totalPages + '</a></li>'
            );
          }

          // Add Next button
          if (currentPage < totalPages - 1) {
            $('#paginationControls').append(
              '<li><a onclick="loadTrips(' + (currentPage + 1) + ')">&raquo;</a></li>'
            );
          }
        }
      });
    }

    function viewTripDetails(tripId) {
      window.location.href = '/admin/trip-detail/' + tripId;
    }

    function updateTrip(tripId) {
      window.location.href = '/admin/update-trip/' + tripId;
    }

    function deleteTrip(tripId, forceDelete = false) {
      const apiEndpoint = forceDelete ? '/admin/api/force-delete-trip/' : '/admin/api/delete-trip/';
      const confirmationMessage = forceDelete
        ? 'Are you sure you want to force delete this trip? This will remove all associated bookings and bills.'
        : 'Are you sure you want to delete this trip?';

      if (confirm(confirmationMessage)) {
        fetch(apiEndpoint + tripId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ tripId: tripId })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert('Trip deleted successfully');
              loadTrips(0);
            } else {
              alert('Failed to delete trip');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            alert('Failed to delete trip');
          });
      }
    }

    $(document).ready(function () {
      loadTrips(0);
    });

    function viewTripDetails(tripId) {
      window.location.href = '/admin/trip-detail/' + tripId;
    }

    function updateTrip(tripId) {
      window.location.href = '/admin/update-trip/' + tripId;
    }

    function deleteTrip(tripId, forceDelete = false) {
      const apiEndpoint = forceDelete ? '/admin/api/force-delete-trip/' : '/admin/api/delete-trip/';
      const confirmationMessage = forceDelete
        ? 'Are you sure you want to force delete this trip? This will remove all associated bookings and bills.'
        : 'Are you sure you want to delete this trip?';

      if (confirm(confirmationMessage)) {
        fetch(apiEndpoint + tripId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ tripId: tripId })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert('Trip deleted successfully');
              loadTrips(0);
            } else {
              alert('Failed to delete trip');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            alert('Failed to delete trip');
          });
      }
    }

    $(document).ready(function () {
      loadTrips(0);
    });
  </script>
</body>

</html>